@Library("Shared") _
pipeline{
  agent any

  parameters{
    string(name: "FRONTEND_DOCKER_TAG", defaultValue: '', description: "Frontend image tag set by CI job")
    string(name: "BACKEND_DOCKER_TAG", defaultValue: '', description: "Backend image tag set by CI job")
  }

  stages{
    stage("Workspace Cleanup"){
      steps{
        script{
          cleanWs()
        }
      }
    }

    stage("Git: Code checkout"){
      steps{
        script{
          code_checkout("https://github.com/Prajwal1414/blog-app.git", "main")       
        }
      }
    }

    stage("Verify: Docker image tags"){
      steps{
        script{
          echo "FRONTEND_DOCKER_TAG: ${params.FRONTEND_DOCKER_TAG}"
          echo "BACKEND_DOCKER_TAG: ${params.BACKEND_DOCKER_TAG}"
        }
      }
    }

    stage("Update: K8s manifests"){
      steps{
        script{
          dir('kubernetes'){
            sh """
              sed -i -e "s|image: prajwalkumar1453/frontend:.*|image: prajwalkumar1453/frontend:${params.FRONTEND_DOCKER_TAG}|g" frontend-deployment.yaml
            """
          }

          dir('kubernetes'){
            sh """
              sed -i -e "s|image: prajwalkumar1453/backend:.*|image: prajwalkumar1453/backend:${params.BACKEND_DOCKER_TAG}|g" backend-deployment.yaml
            """
          }
        }
      }
    }

    stage("Git: Code update and push to GitHub"){
      steps{
        script{
          withCredentials([gitUsernamePassword(credentialsId: '7ba9482c-ae58-4109-8725-c40e5e73b221'), gitToolName: 'Default']){
            sh '''
            echo "Checking repo status"  
            git status

            echo "Adding changes to git: "
            git add .

            echo "Commiting changes"
            git commit -m "Update env variable"

            echo "Pushing changes to github:"
            git push https://github.com/Prajwal1414/blog-app.git main
            '''
          }
        }
      }
    }
  }

  post{
    success{
      emailext(
      attachLog: true,
      from: 'portgazdace1995@gmail.com',
      to: 'prajwalphs@gmail.com',
      subject: "Wanderlust Application has been updated and deployed - '${currentBuild.result}'",
      mimeType: 'text/html',
      body: """
      <html>
        <body style="font-family: Arial, sans-serif; background-color: #f9f9f9; padding: 20px;">
          <div style="max-width: 600px; margin: auto; border-radius: 10px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
            <div style="background-color: #4CAF50; color: white; padding: 20px; text-align: center;">
              <h2>Build Success ✅</h2>
            </div>
            <div style="padding: 20px; background-color: white;">
              <p><strong>Project:</strong> ${env.JOB_NAME}</p>
              <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
              <p><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
              <p>The application has been successfully updated and deployed.</p>
            </div>
          </div>
        </body>
      </html>
      """
      )
    }

    failure{
      attachLog: true,
      from: 'portgazdace1995@gmail.com',
      to: 'prajwalphs@gmail.com',
      subject: "Wanderlust Application has been updated and deployed - '${currentBuild.result}'",
      mimeType: 'text/html',
      body: """
      <html>
        <body style="font-family: Arial, sans-serif; background-color: #f9f9f9; padding: 20px;">
          <div style="max-width: 600px; margin: auto; border-radius: 10px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
            <div style="background-color: #f44336; color: white; padding: 20px; text-align: center;">
              <h2>Build Failed ❌</h2>
            </div>
            <div style="padding: 20px; background-color: white;">
              <p><strong>Project:</strong> ${env.JOB_NAME}</p>
              <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
              <p>Please check the Jenkins console output for details.</p>
            </div>
          </div>
        </body>
      </html>
      """
    }
  }

}
